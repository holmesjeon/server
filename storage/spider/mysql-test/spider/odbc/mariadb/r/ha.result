for master_1
for child2
child2_1
child2_2
child2_3
for child3
child3_1
child3_2
child3_3
for master_1
for child2
child2_1
child2_2
child2_3
for child3
child3_1
child3_2
child3_3

drop and create databases
connection master_1;
DROP DATABASE IF EXISTS auto_test_local;
CREATE DATABASE auto_test_local;
USE auto_test_local;
SELECT spider_direct_sql('DROP DATABASE IF EXISTS auto_test_remote', '', 'srv "s_2_1_test", driver "MariaDB ODBC 3.0 Driver"');
spider_direct_sql('DROP DATABASE IF EXISTS auto_test_remote', '', 'srv "s_2_1_test", driver "MariaDB ODBC 3.0 Driver"')
1
SELECT spider_direct_sql('CREATE DATABASE auto_test_remote', '', 'srv "s_2_1_test", driver "MariaDB ODBC 3.0 Driver"') ;
SELECT spider_direct_sql('USE auto_test_remote', '', 'srv "s_2_1_test", driver "MariaDB ODBC 3.0 Driver"');
spider_direct_sql('CREATE DATABASE auto_test_remote', '', 'srv "s_2_1_test", driver "MariaDB ODBC 3.0 Driver"')
1
spider_direct_sql('USE auto_test_remote', '', 'srv "s_2_1_test", driver "MariaDB ODBC 3.0 Driver"')
1
SELECT spider_direct_sql('DROP DATABASE IF EXISTS auto_test_remote2', '', 'srv "s_2_2_test", driver "MariaDB ODBC 3.0 Driver"');
spider_direct_sql('DROP DATABASE IF EXISTS auto_test_remote2', '', 'srv "s_2_2_test", driver "MariaDB ODBC 3.0 Driver"')
1
SELECT spider_direct_sql('CREATE DATABASE auto_test_remote2', '', 'srv "s_2_2_test", driver "MariaDB ODBC 3.0 Driver"') ;
SELECT spider_direct_sql('USE auto_test_remote2', '', 'srv "s_2_2_test", driver "MariaDB ODBC 3.0 Driver"');
spider_direct_sql('CREATE DATABASE auto_test_remote2', '', 'srv "s_2_2_test", driver "MariaDB ODBC 3.0 Driver"')
1
spider_direct_sql('USE auto_test_remote2', '', 'srv "s_2_2_test", driver "MariaDB ODBC 3.0 Driver"')
1
SELECT spider_direct_sql('DROP DATABASE IF EXISTS auto_test_remote3', '', 'srv "s_2_3_test", driver "MariaDB ODBC 3.0 Driver"');
spider_direct_sql('DROP DATABASE IF EXISTS auto_test_remote3', '', 'srv "s_2_3_test", driver "MariaDB ODBC 3.0 Driver"')
1
SELECT spider_direct_sql('CREATE DATABASE auto_test_remote3', '', 'srv "s_2_3_test", driver "MariaDB ODBC 3.0 Driver"') ;
SELECT spider_direct_sql('USE auto_test_remote3', '', 'srv "s_2_3_test", driver "MariaDB ODBC 3.0 Driver"');
spider_direct_sql('CREATE DATABASE auto_test_remote3', '', 'srv "s_2_3_test", driver "MariaDB ODBC 3.0 Driver"')
1
spider_direct_sql('USE auto_test_remote3', '', 'srv "s_2_3_test", driver "MariaDB ODBC 3.0 Driver"')
1
connection child3_1;
DROP DATABASE IF EXISTS auto_test_local;
CREATE DATABASE auto_test_local;
USE auto_test_local;
connection child3_2;
DROP DATABASE IF EXISTS auto_test_local;
CREATE DATABASE auto_test_local;
USE auto_test_local;
connection child3_3;
DROP DATABASE IF EXISTS auto_test_local;
CREATE DATABASE auto_test_local;
USE auto_test_local;

test select 1
connection master_1;
SELECT 1;
1
1

create table test
connection master_1;
DROP TABLE IF EXISTS ta_l;
CREATE TABLE ta_l (
a INT,
b CHAR(1),
c DATETIME,
PRIMARY KEY(a)
) MASTER_1_ENGINE MASTER_1_CHARSET MASTER_1_COMMENT_HA_2_1
INSERT INTO ta_l (a, b, c) VALUES
(1, 'a', '2008-08-01 10:21:39'),
(2, 'b', '2000-01-01 00:00:00'),
(3, 'e', '2007-06-04 20:03:11'),
(4, 'd', '2003-11-30 05:01:03'),
(5, 'c', '2001-12-31 23:59:59');

select test
connection master_1;
SELECT a, b, date_format(c, '%Y-%m-%d %H:%i:%s') FROM ta_l ORDER BY a;
a	b	date_format(c, '%Y-%m-%d %H:%i:%s')
1	a	2008-08-01 00:00:00
2	b	2000-01-01 00:00:00
3	e	2007-06-04 00:00:00
4	d	2003-11-30 00:00:00
5	c	2001-12-31 00:00:00

fail-over test
connection master_1;
SHOW GLOBAL STATUS LIKE 'Spider_mon_table_cache_version%';
Variable_name	Value
Spider_mon_table_cache_version	0
Spider_mon_table_cache_version_req	1
INSERT INTO ta_l (a, b, c) VALUES
(6, 'e', '2011-05-05 20:04:05');
ERROR HY000: Table 'auto_test_remote2.ta_r3' get a problem
DELETE FROM ta_l WHERE a = 6;
SELECT db_name, table_name, link_id, link_status FROM mysql.spider_tables
ORDER BY db_name, table_name, link_id;
db_name	table_name	link_id	link_status
auto_test_local	ta_l	0	1
auto_test_local	ta_l	1	3
SELECT db_name, table_name, link_id FROM mysql.spider_link_failed_log;
db_name	table_name	link_id
auto_test_local	ta_l	1
SHOW GLOBAL STATUS LIKE 'Spider_mon_table_cache_version%';
Variable_name	Value
Spider_mon_table_cache_version	1
Spider_mon_table_cache_version_req	1
INSERT INTO ta_l (a, b, c) VALUES
(6, 'e', '2011-05-05 20:04:05');
SELECT a, b, date_format(c, '%Y-%m-%d %H:%i:%s') FROM ta_l ORDER BY a;
a	b	date_format(c, '%Y-%m-%d %H:%i:%s')
1	a	2008-08-01 00:00:00
2	b	2000-01-01 00:00:00
3	e	2007-06-04 00:00:00
4	d	2003-11-30 00:00:00
5	c	2001-12-31 00:00:00
6	e	2011-05-05 00:00:00

recovery test
connection master_1;
ALTER TABLE ta_l
CONNECTION='msi "5", mkd "2", lst "0 2"';
SELECT db_name, table_name, link_id, link_status FROM mysql.spider_tables
ORDER BY db_name, table_name, link_id;
db_name	table_name	link_id	link_status
auto_test_local	ta_l	0	1
auto_test_local	ta_l	1	2
show create table mysql.spider_tables;
Table	Create Table
spider_tables	CREATE TABLE `spider_tables` (
  `db_name` char(64) COLLATE utf8_bin NOT NULL DEFAULT '',
  `table_name` char(199) COLLATE utf8_bin NOT NULL DEFAULT '',
  `link_id` int(11) NOT NULL DEFAULT 0,
  `priority` bigint(20) NOT NULL DEFAULT 0,
  `server` char(64) COLLATE utf8_bin DEFAULT NULL,
  `scheme` char(64) COLLATE utf8_bin DEFAULT NULL,
  `host` char(64) COLLATE utf8_bin DEFAULT NULL,
  `port` char(5) COLLATE utf8_bin DEFAULT NULL,
  `socket` text COLLATE utf8_bin DEFAULT NULL,
  `username` char(64) COLLATE utf8_bin DEFAULT NULL,
  `password` char(64) COLLATE utf8_bin DEFAULT NULL,
  `ssl_ca` text COLLATE utf8_bin DEFAULT NULL,
  `ssl_capath` text COLLATE utf8_bin DEFAULT NULL,
  `ssl_cert` text COLLATE utf8_bin DEFAULT NULL,
  `ssl_cipher` char(64) COLLATE utf8_bin DEFAULT NULL,
  `ssl_key` text COLLATE utf8_bin DEFAULT NULL,
  `ssl_verify_server_cert` tinyint(4) NOT NULL DEFAULT 0,
  `monitoring_binlog_pos_at_failing` tinyint(4) NOT NULL DEFAULT 0,
  `default_file` text COLLATE utf8_bin DEFAULT NULL,
  `default_group` char(64) COLLATE utf8_bin DEFAULT NULL,
  `dsn` char(64) COLLATE utf8_bin DEFAULT NULL,
  `filedsn` text COLLATE utf8_bin DEFAULT NULL,
  `driver` char(64) COLLATE utf8_bin DEFAULT NULL,
  `tgt_db_name` char(64) COLLATE utf8_bin DEFAULT NULL,
  `tgt_table_name` char(64) COLLATE utf8_bin DEFAULT NULL,
  `link_status` tinyint(4) NOT NULL DEFAULT 1,
  `block_status` tinyint(4) NOT NULL DEFAULT 0,
  `static_link_id` char(64) COLLATE utf8_bin DEFAULT NULL,
  PRIMARY KEY (`db_name`,`table_name`,`link_id`),
  UNIQUE KEY `uidx1` (`db_name`,`table_name`,`static_link_id`),
  KEY `idx1` (`priority`)
) ENGINE=Aria DEFAULT CHARSET=utf8 COLLATE=utf8_bin PAGE_CHECKSUM=1 TRANSACTIONAL=1
select * from mysql.spider_tables;
db_name	table_name	link_id	priority	server	scheme	host	port	socket	username	password	ssl_ca	ssl_capath	ssl_cert	ssl_cipher	ssl_key	ssl_verify_server_cert	monitoring_binlog_pos_at_failing	default_file	default_group	dsn	filedsn	driver	tgt_db_name	tgt_table_name	link_status	block_status	static_link_id
auto_test_local	ta_l	0	1000000	s_2_1	odbc_mariadb		NULL									0	0					MariaDB ODBC 3.0 Driver	auto_test_remote	ta_r	1	0	NULL
auto_test_local	ta_l	1	1000000	s_2_2	odbc_mariadb		NULL									0	0					MariaDB ODBC 3.0 Driver	auto_test_remote2	ta_r3	2	0	NULL
SELECT spider_copy_tables('ta_l', '0', '1');
spider_copy_tables('ta_l', '0', '1')
1
connection master_1;
ALTER TABLE ta_l
CONNECTION='msi "5", mkd "2", lst "0 1"';
SELECT db_name, table_name, link_id, link_status FROM mysql.spider_tables
ORDER BY db_name, table_name, link_id;
db_name	table_name	link_id	link_status
auto_test_local	ta_l	0	1
auto_test_local	ta_l	1	1
INSERT INTO ta_l (a, b, c) VALUES
(8, 'g', '2011-05-05 21:33:30');
SELECT a, b, date_format(c, '%Y-%m-%d %H:%i:%s') FROM ta_l ORDER BY a;
a	b	date_format(c, '%Y-%m-%d %H:%i:%s')
1	a	2008-08-01 00:00:00
2	b	2000-01-01 00:00:00
3	e	2007-06-04 00:00:00
4	d	2003-11-30 00:00:00
5	c	2001-12-31 00:00:00
6	e	2011-05-05 00:00:00
8	g	2011-05-05 00:00:00
DROP TABLE ta_l;
connection master_1;
SELECT spider_flush_table_mon_cache();
spider_flush_table_mon_cache()
1

active standby test
create table test
connection master_1;
DROP TABLE IF EXISTS ta_l;
CREATE TABLE ta_l (
a INT,
b CHAR(1),
c DATETIME,
PRIMARY KEY(a)
) MASTER_1_ENGINE MASTER_1_CHARSET MASTER_1_COMMENT_HA_AS_2_1
INSERT INTO ta_l (a, b, c) VALUES
(1, 'a', '2008-08-01 10:21:39'),
(2, 'b', '2000-01-01 00:00:00'),
(3, 'e', '2007-06-04 20:03:11'),
(4, 'd', '2003-11-30 05:01:03'),
(5, 'c', '2001-12-31 23:59:59');

select test
connection master_1;
SELECT a, b, date_format(c, '%Y-%m-%d %H:%i:%s') FROM ta_l ORDER BY a;
a	b	date_format(c, '%Y-%m-%d %H:%i:%s')
1	a	2008-08-01 00:00:00
2	b	2000-01-01 00:00:00
3	e	2007-06-04 00:00:00
4	d	2003-11-30 00:00:00
5	c	2001-12-31 00:00:00

fail-over test
connection master_1;
SHOW GLOBAL STATUS LIKE 'Spider_mon_table_cache_version%';
Variable_name	Value
Spider_mon_table_cache_version	1
Spider_mon_table_cache_version_req	2
INSERT INTO ta_l (a, b, c) VALUES
(6, 'e', '2011-05-05 20:04:05');
ERROR HY000: Table 'auto_test_remote.ta_r' get a problem
SELECT db_name, table_name, link_id, link_status FROM mysql.spider_tables
ORDER BY db_name, table_name, link_id;
db_name	table_name	link_id	link_status
auto_test_local	ta_l	0	3
auto_test_local	ta_l	1	1
SELECT db_name, table_name, link_id FROM mysql.spider_link_failed_log;
db_name	table_name	link_id
auto_test_local	ta_l	1
auto_test_local	ta_l	0
SHOW GLOBAL STATUS LIKE 'Spider_mon_table_cache_version%';
Variable_name	Value
Spider_mon_table_cache_version	2
Spider_mon_table_cache_version_req	2
INSERT INTO ta_l (a, b, c) VALUES
(6, 'e', '2011-05-05 20:04:05');
SELECT a, b, date_format(c, '%Y-%m-%d %H:%i:%s') FROM ta_l ORDER BY a;
a	b	date_format(c, '%Y-%m-%d %H:%i:%s')
6	e	2011-05-05 00:00:00

recovery test
connection master_1;
ALTER TABLE ta_l
CONNECTION='msi "5", mkd "2", alc "1", lst "1 0"';
SELECT db_name, table_name, link_id, link_status FROM mysql.spider_tables
ORDER BY db_name, table_name, link_id;
db_name	table_name	link_id	link_status
auto_test_local	ta_l	0	1
auto_test_local	ta_l	1	1
INSERT INTO ta_l (a, b, c) VALUES
(8, 'g', '2011-05-05 21:33:30');
SELECT a, b, date_format(c, '%Y-%m-%d %H:%i:%s') FROM ta_l ORDER BY a;
a	b	date_format(c, '%Y-%m-%d %H:%i:%s')
8	g	2011-05-05 00:00:00
DROP TABLE ta_l;
connection master_1;
SELECT spider_flush_table_mon_cache();
spider_flush_table_mon_cache()
1

deinit
connection master_1;
DROP DATABASE IF EXISTS auto_test_local;
SELECT spider_direct_sql('DROP DATABASE auto_test_remote', '', 'srv "s_2_1", driver "MariaDB ODBC 3.0 Driver"');
spider_direct_sql('DROP DATABASE auto_test_remote', '', 'srv "s_2_1", driver "MariaDB ODBC 3.0 Driver"')
1
SELECT spider_direct_sql('DROP DATABASE auto_test_remote2', '', 'srv "s_2_2", driver "MariaDB ODBC 3.0 Driver"');
spider_direct_sql('DROP DATABASE auto_test_remote2', '', 'srv "s_2_2", driver "MariaDB ODBC 3.0 Driver"')
1
SELECT spider_direct_sql('DROP DATABASE auto_test_remote3', '', 'srv "s_2_3", driver "MariaDB ODBC 3.0 Driver"');
spider_direct_sql('DROP DATABASE auto_test_remote3', '', 'srv "s_2_3", driver "MariaDB ODBC 3.0 Driver"')
1
connection child3_1;
DROP DATABASE IF EXISTS auto_test_local;
connection child3_2;
DROP DATABASE IF EXISTS auto_test_local;
connection child3_3;
DROP DATABASE IF EXISTS auto_test_local;
for master_1
for child2
child2_1
child2_2
child2_3
for child3
child3_1
child3_2
child3_3
for child3
child3_3
child3_2
child3_1
for child2
child2_3
child2_2
child2_1
for master_1

end of test
